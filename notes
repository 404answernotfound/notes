#!/bin/bash

configured_dir=${NOTES_DIRECTORY%/} # Remove trailing slashes
notes_dir="${configured_dir:-$HOME/notes}"
escaped_notes_dir=$(echo $notes_dir | sed -e 's/[]\/$*.^|[]/\\&/g')

without_notes_dir() {
    cat | sed -e s/^$escaped_notes_dir//g | sed -E "s/^\/+//g" 
}

find_notes() {
    find_output=$(find "$notes_dir" -ipath "$notes_dir/*$**" -type f 2>&1)
    find_result=$?
    formatted_output=$(echo "$find_output" | without_notes_dir)

    if [[ $find_result == 0 && $formatted_output ]]; then
        echo "$formatted_output"
        return 0
    else
        return 2
    fi
}

grep_notes() {
    if [ ! "$#" -gt 0 ]; then
        echo "Grep requires a pattern, but none was provided."
        return 1
    fi

    grep_output=$(grep -r "$notes_dir" -e "$*" 2>&1)
    grep_result=$?
    formatted_output=$(echo "$grep_output" | without_notes_dir)

    if [[ $grep_result == 0 && $formatted_output ]]; then
        echo "$formatted_output"
        return 0
    else
        return 2
    fi
}

new_note() {
    note_path=$notes_dir/$1.md 
    mkdir -p $(dirname $note_path)
    $EDITOR $note_path
}

usage() {
	cat <<EOF
notes is a command line note taking tool.

Usage:
    notes new <name>                # Create a new note
    notes find [pattern]                # Search notes by filename and path
    notes grep <pattern>                # Search notes by content
    notes open                          # Open your notes directory
    notes --help                        # Print this usage information

Your notes directory is $notes_dir. You can
override this by setting \$NOTES_DIRECTORY to your preferred path.
EOF
}

main() {
	ret=0
    cmd=""

	if [ -z "$1" ]; then
        echo "No command specified\n"
        usage
        exit 1
    fi

    case "$1" in
        "new" )
            cmd="new_note"
            ;;
        "find" )
            cmd="find_notes"
            ;;
        "grep" )
            cmd="grep_notes"
            ;;
        "open" )
            cmd="open $notes_dir"
            ;;
        --help | -help | -h )
            cmd="usage"
            ;;
        * )
            echo "$1 is not a recognized notes command.\n"
            cmd="usage"
            ret=1
            ;;
    esac
    shift

    $cmd $@
    ret=$[$ret+$?]
    exit $ret
}
main "$@"